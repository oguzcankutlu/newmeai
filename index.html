<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The New Me - GÃ¼lÃ¼ÅŸ TasarÄ±mÄ±</title>
    <style>
        /* --- TASARIM (CSS) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); min-height: 100vh; padding: 20px; display: flex; justify-content: center; align-items: center; }
        
        .container { 
            width: 100%; max-width: 600px; background: white; 
            border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            overflow: hidden; position: relative;
        }

        .header { background: white; padding: 20px; text-align: center; border-bottom: 1px solid #eee; }
        .brand { font-size: 24px; font-weight: 800; color: #333; letter-spacing: -1px; }

        .screen { display: none; padding: 30px; animation: fadeIn 0.4s ease; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* YÃ¼kleme Kutusu */
        .upload-box { 
            border: 3px dashed #cbd5e1; border-radius: 16px; padding: 40px 20px; 
            text-align: center; cursor: pointer; transition: 0.3s; background: #f8fafc;
        }
        .upload-box:hover { border-color: #E31E24; background: #fff5f5; }
        .upload-box.has-file { border-color: #10b981; background: #ecfdf5; }
        .upload-icon { font-size: 48px; margin-bottom: 10px; display: block; }

        /* Resim Ã–nizleme */
        .preview-container { margin-top: 20px; border-radius: 12px; overflow: hidden; display: none; }
        .preview-container img { width: 100%; display: block; }

        /* SeÃ§enekler */
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        .option-card { 
            padding: 15px; border: 2px solid #e2e8f0; border-radius: 12px; 
            text-align: center; cursor: pointer; transition: 0.2s; background: white;
        }
        .option-card:hover { border-color: #cbd5e1; }
        .option-card.selected { border-color: #E31E24; background: #fff5f5; font-weight: bold; color: #E31E24; }

        /* Butonlar */
        .btn { 
            width: 100%; padding: 16px; border: none; border-radius: 12px; 
            font-size: 16px; font-weight: 700; cursor: pointer; transition: 0.2s; margin-top: 10px;
        }
        .btn-primary { background: #E31E24; color: white; }
        .btn-primary:hover { background: #c0151a; transform: translateY(-2px); }
        .btn-primary:disabled { background: #cbd5e1; cursor: not-allowed; transform: none; }
        .btn-secondary { background: white; color: #64748b; border: 2px solid #e2e8f0; }
        .btn-secondary:hover { background: #f1f5f9; color: #334155; }

        /* Loading Overlay */
        .loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 100;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            text-align: center;
        }
        .spinner {
            width: 50px; height: 50px; border: 4px solid #e2e8f0; 
            border-top-color: #E31E24; border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .download-btn { background: #10b981; color: white; }
        .download-btn:hover { background: #059669; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <div class="brand">The New Me âœ¨</div>
        </div>

        <div id="screen1" class="screen active">
            <h2 style="margin-bottom: 10px; color:#1e293b;">FotoÄŸrafÄ±nÄ± YÃ¼kle</h2>
            <p style="color:#64748b; margin-bottom: 25px; font-size: 14px;">Net ve aydÄ±nlÄ±k bir yÃ¼z fotoÄŸrafÄ± seÃ§in.</p>
            
            <div id="uploadBox" class="upload-box">
                <span class="upload-icon">ğŸ“¸</span>
                <div id="uploadText" style="font-weight:600; color:#475569;">FotoÄŸraf SeÃ§mek Ä°Ã§in TÄ±kla</div>
                <input type="file" id="fileInput" accept="image/*" style="display:none">
            </div>

            <div id="previewContainer" class="preview-container">
                <img id="previewImage">
            </div>

            <label style="display:flex; align-items:center; gap:10px; margin: 20px 0; cursor:pointer;">
                <input type="checkbox" id="consentCheck" style="width:18px; height:18px;">
                <span style="font-size:14px; color:#475569;">FotoÄŸrafÄ±mÄ±n iÅŸlenmesini onaylÄ±yorum.</span>
            </label>

            <button id="btnNext" class="btn btn-primary" disabled>Ä°leri Devam Et â†’</button>
        </div>

        <div id="screen2" class="screen">
            <h2 style="margin-bottom: 20px; color:#1e293b;">TarzÄ±nÄ± SeÃ§</h2>
            
            <h4 style="margin-bottom: 10px; color:#64748b;">DiÅŸ Tonu</h4>
            <div class="options-grid">
                <div class="option-card" onclick="selectOption('tone', 'natural', this)">
                    <div style="font-size:24px; margin-bottom:5px">ğŸ¤</div>
                    DoÄŸal Ton
                </div>
                <div class="option-card" onclick="selectOption('tone', 'bright', this)">
                    <div style="font-size:24px; margin-bottom:5px">âœ¨</div>
                    Hollywood BeyazÄ±
                </div>
            </div>

            <h4 style="margin-bottom: 10px; color:#64748b;">DiÅŸ Åekli</h4>
            <div class="options-grid">
                <div class="option-card" onclick="selectOption('shape', 'natural', this)">
                    <div style="font-size:24px; margin-bottom:5px">ğŸƒ</div>
                    DoÄŸal YapÄ±
                </div>
                <div class="option-card" onclick="selectOption('shape', 'perfect', this)">
                    <div style="font-size:24px; margin-bottom:5px">â­</div>
                    Kusursuz Dizilim
                </div>
            </div>

            <button id="btnGenerate" class="btn btn-primary" disabled>GÃ¼lÃ¼ÅŸÃ¼mÃ¼ Tasarla ğŸ¨</button>
            <button onclick="showScreen(1)" class="btn btn-secondary">â† Geri DÃ¶n</button>
        </div>

        <div id="screen3" class="screen">
            <h2 style="margin-bottom: 20px; color:#1e293b; text-align:center;">Ä°ÅŸte Yeni GÃ¼lÃ¼ÅŸÃ¼n! ğŸ‰</h2>
            
            <div style="border-radius:12px; overflow:hidden; margin-bottom:20px; border: 2px solid #eee;">
                <img id="resultImage" style="width:100%; display:block;">
            </div>

            <button id="btnDownload" class="btn download-btn">Resmi Ä°ndir ğŸ’¾</button>
            <button onclick="location.reload()" class="btn btn-secondary">BaÅŸtan BaÅŸla ğŸ”„</button>
        </div>
    </div>

    <div id="loader" class="loader">
        <div class="spinner"></div>
        <h3 id="loadingText" style="color:#333;">Ä°ÅŸleniyor...</h3>
        <p style="color:#666; font-size:14px; margin-top:5px;">LÃ¼tfen sayfayÄ± kapatmayÄ±n.</p>
    </div>

    <script>
        // --- DEÄÄ°ÅKENLER ---
        let finalImageBase64 = null;
        let selectedTone = null;
        let selectedShape = null;

        // --- ELEMENTLER ---
        const uploadBox = document.getElementById('uploadBox');
        const fileInput = document.getElementById('fileInput');
        const previewContainer = document.getElementById('previewContainer');
        const previewImg = document.getElementById('previewImage');
        const consentCheck = document.getElementById('consentCheck');
        const btnNext = document.getElementById('btnNext');
        const btnGenerate = document.getElementById('btnGenerate');
        const loader = document.getElementById('loader');

        // --- 1. TIKLAMA SORUNUNU Ã‡Ã–ZEN KOD ---
        uploadBox.addEventListener('click', () => {
            fileInput.click(); // KutucuÄŸa basÄ±nca input aÃ§Ä±lsÄ±n
        });

        // --- 2. DOSYA SEÃ‡ME VE KÃœÃ‡ÃœLTME ---
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // Loader aÃ§
            loader.style.display = 'flex';
            document.getElementById('loadingText').innerText = "FotoÄŸraf HazÄ±rlanÄ±yor...";

            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    // Canvas ile yeniden boyutlandÄ±rma (Max 1024px)
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    const maxSize = 1024;

                    if (width > height) {
                        if (width > maxSize) { height *= maxSize / width; width = maxSize; }
                    } else {
                        if (height > maxSize) { width *= maxSize / height; height = maxSize; }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // SÄ±kÄ±ÅŸtÄ±rÄ±lmÄ±ÅŸ JPEG (0.85 kalite)
                    finalImageBase64 = canvas.toDataURL('image/jpeg', 0.85);

                    // Ã–nizlemeyi gÃ¶ster
                    previewImg.src = finalImageBase64;
                    previewContainer.style.display = 'block';
                    uploadBox.classList.add('has-file');
                    document.getElementById('uploadText').innerText = "FotoÄŸrafÄ± DeÄŸiÅŸtir";
                    
                    loader.style.display = 'none';
                    checkValidation();
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        // --- 3. DOÄRULAMA KONTROLÃœ ---
        consentCheck.addEventListener('change', checkValidation);

        function checkValidation() {
            // Hem resim var mÄ± hem onay verilmiÅŸ mi?
            if (finalImageBase64 && consentCheck.checked) {
                btnNext.disabled = false;
            } else {
                btnNext.disabled = true;
            }
        }

        // --- 4. EKRAN GEÃ‡Ä°ÅLERÄ° ---
        function showScreen(n) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen' + n).classList.add('active');
        }
        
        btnNext.addEventListener('click', () => showScreen(2));

        // --- 5. SEÃ‡ENEK Ä°ÅLEMLERÄ° ---
        window.selectOption = function(type, value, el) {
            // GÃ¶rsel seÃ§im efekti
            el.parentElement.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');

            // DeÄŸerleri ata
            if (type === 'tone') selectedTone = value;
            if (type === 'shape') selectedShape = value;

            // Butonu aktif et
            if (selectedTone && selectedShape) {
                btnGenerate.disabled = false;
            }
        };

        // --- 6. GÃœLÃœÅ OLUÅTURMA (GENERATE) ---
        btnGenerate.addEventListener('click', async () => {
            loader.style.display = 'flex';
            document.getElementById('loadingText').innerText = "Yapay Zeka Ã‡alÄ±ÅŸÄ±yor...";

            try {
                // Maske oluÅŸtur
                const maskBase64 = await createSimpleMask(finalImageBase64);
                
                // Prompt hazÄ±rla
                const prompt = `Professional dental photography, ${selectedTone === 'bright' ? 'extremely bright white teeth, hollywood smile' : 'natural ivory teeth color'}, ${selectedShape === 'perfect' ? 'perfectly aligned veneers' : 'natural tooth shape'}, photorealistic, 8k, high detail face.`;

                // Backend'e istek at
                const res = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        imageBase64: finalImageBase64,
                        maskBase64: maskBase64,
                        prompt: prompt
                    })
                });

                // JSON YanÄ±tÄ± KontrolÃ¼
                let data;
                try {
                    data = await res.json();
                } catch(e) {
                    throw new Error("Sunucudan geÃ§ersiz yanÄ±t geldi.");
                }

                if(!res.ok) throw new Error(data.error || "Sunucu hatasÄ± oluÅŸtu.");
                if(!data.tasklist || !data.tasklist[0]) throw new Error("Task ID alÄ±namadÄ±.");

                const taskId = data.tasklist[0].uuid;
                console.log("Task BaÅŸladÄ±:", taskId);

                // Sonucu Bekle (Polling)
                const resultUrl = await pollStatus(taskId);

                // Sonucu GÃ¶ster
                const resultImg = document.getElementById('resultImage');
                resultImg.src = resultUrl;

                // Ä°ndirme Butonunu Ayarla
                document.getElementById('btnDownload').onclick = () => {
                    const link = document.createElement('a');
                    link.href = resultUrl;
                    link.download = 'yeni-gulusum.png';
                    link.click();
                };

                loader.style.display = 'none';
                showScreen(3);

            } catch (err) {
                loader.style.display = 'none';
                alert("HATA: " + err.message);
                console.error(err);
            }
        });

        // --- YARDIMCI FONKSÄ°YONLAR ---

        // Maske OluÅŸturucu
        function createSimpleMask(imgSrc) {
            return new Promise(resolve => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    
                    // Siyah Zemin
                    ctx.fillStyle = 'black';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    // Beyaz Kutu (AÄŸÄ±z BÃ¶lgesi Tahmini)
                    // YÃ¼zÃ¼n alt %38'lik kÄ±smÄ±na, %40 geniÅŸliÄŸinde kutu
                    const w = img.width * 0.40; 
                    const h = img.height * 0.15;
                    const x = (img.width - w) / 2;
                    const y = img.height * 0.62; 
                    
                    ctx.fillStyle = 'white';
                    ctx.fillRect(x, y, w, h);
                    resolve(canvas.toDataURL('image/png'));
                };
                img.src = imgSrc;
            });
        }

        // Durum KontrolcÃ¼ (Polling)
        async function pollStatus(taskId) {
            // 45 deneme x 2 saniye = 90 saniye bekleme sÃ¼resi
            for(let i=0; i<45; i++) { 
                await new Promise(r => setTimeout(r, 2000));
                
                try {
                    const res = await fetch(`/api/status?taskId=${taskId}`);
                    if(!res.ok) continue; // Hata varsa tekrar dene
                    
                    const data = await res.json();
                    if(!data.tasklist || !data.tasklist[0]) continue;

                    const task = data.tasklist[0];
                    
                    // Ä°ÅŸlem bittiyse
                    if(task.status === 'task_postprocess_end') {
                        return task.parameters.outputImage;
                    }
                    
                    // Hata verdiyse
                    if(task.status.includes('fail') || task.status.includes('error')) {
                        throw new Error('Ä°ÅŸlem baÅŸarÄ±sÄ±z: ' + (task.debugerror || task.status));
                    }
                } catch(e) {
                    console.log("Bekleniyor...", e);
                }
            }
            throw new Error('Zaman aÅŸÄ±mÄ±. Ä°ÅŸlem Ã§ok uzun sÃ¼rdÃ¼.');
        }
    </script>
</body>
</html>
