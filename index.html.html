<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The New Me - G√ºl√º≈ü Sim√ºlasyonu</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #F8FAFC 0%, #e8ecf1 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; border-radius: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.08); overflow: hidden; }
        .header { background: white; padding: 30px 40px; border-bottom: 1px solid #e8ecf1; }
        .brand-name { font-size: 24px; font-weight: 700; color: #1a1a2e; }
        .content { padding: 40px; }
        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Upload Area */
        .upload-area { border: 3px dashed #cbd5e1; border-radius: 16px; padding: 50px; text-align: center; cursor: pointer; background: #f8fafc; margin-bottom: 20px; transition: all 0.3s; }
        .upload-area:hover { border-color: #E31E24; background: #FEF2F2; }
        .upload-area.has-file { border-color: #10b981; background: #f0fdf4; }
        .preview-image { max-width: 100%; max-height: 300px; border-radius: 12px; margin: 20px auto; display: none; }
        .preview-image.visible { display: block; }
        
        /* Buttons */
        .btn { padding: 16px; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; width: 100%; font-size: 16px; margin-top: 10px; }
        .btn-primary { background: #E31E24; color: white; }
        .btn-primary:disabled { background: #cbd5e1; cursor: not-allowed; }
        .btn-secondary { background: white; color: #E31E24; border: 2px solid #E31E24; }

        /* Options */
        .options-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .option-btn { padding: 20px; border: 2px solid #e2e8f0; border-radius: 12px; text-align: center; cursor: pointer; }
        .option-btn.selected { border-color: #E31E24; background: #FEF2F2; font-weight: bold; }
        
        /* Results */
        .result-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .result-image { width: 100%; border-radius: 8px; }
        
        /* Loading */
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: none; flex-direction: column; align-items: center; justify-content: center; color: white; z-index: 999; }
        .loading-overlay.active { display: flex; }
        .spinner { width: 50px; height: 50px; border: 5px solid #fff; border-top-color: #E31E24; border-radius: 50%; animation: spin 1s infinite; margin-bottom: 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="brand-name">The New Me</div>
        </div>

        <div class="content">
            <div id="screen1" class="screen active">
                <h1>Fotoƒüraf Y√ºkle</h1>
                <p style="color:#666; margin-bottom:20px">G√ºl√º≈ü√ºn√º deƒüi≈ütirmek i√ßin fotoƒürafƒ±nƒ± y√ºkle.</p>
                
                <div id="uploadArea" class="upload-area">
                    <div style="font-size:40px">üì∏</div>
                    <div>Fotoƒüraf Se√ßmek ƒ∞√ßin Tƒ±kla</div>
                    <input type="file" id="fileInput" accept="image/*" style="display:none">
                </div>
                <img id="previewImage" class="preview-image">
                
                <label style="display:flex; gap:10px; align-items:center; margin: 20px 0;">
                    <input type="checkbox" id="consentCheckbox"> 
                    <span>Fotoƒürafƒ±mƒ±n i≈ülenmesini kabul ediyorum.</span>
                </label>
                
                <button id="nextBtn1" class="btn btn-primary" disabled>ƒ∞leri ‚Üí</button>
            </div>

            <div id="screen2" class="screen">
                <h1>Stilini Se√ß</h1>
                
                <h3 style="margin: 20px 0 10px;">Di≈ü Tonu</h3>
                <div class="options-row">
                    <div class="option-btn" data-type="tone" data-value="natural">Doƒüal Ton ü§é</div>
                    <div class="option-btn" data-type="tone" data-value="bright">Hollywood Beyazƒ± ‚ú®</div>
                </div>

                <h3 style="margin: 20px 0 10px;">Di≈ü ≈ûekli</h3>
                <div class="options-row">
                    <div class="option-btn" data-type="shape" data-value="natural">Doƒüal ≈ûekil üî≤</div>
                    <div class="option-btn" data-type="shape" data-value="perfect">Kusursuz Dizilim ‚≠ê</div>
                </div>

                <button id="generateBtn" class="btn btn-primary" disabled>G√ºl√º≈ü Olu≈ütur üé®</button>
                <button onclick="switchScreen(1)" class="btn btn-secondary">‚Üê Geri D√∂n</button>
            </div>

            <div id="screen3" class="screen">
                <h1>Sonu√ßlar</h1>
                <div class="result-container">
                    <div>
                        <div style="text-align:center; margin-bottom:5px; font-weight:bold">√ñNCE</div>
                        <img id="beforeImage" class="result-image">
                    </div>
                    <div>
                        <div style="text-align:center; margin-bottom:5px; font-weight:bold; color:#E31E24">SONRA</div>
                        <img id="afterImage" class="result-image">
                    </div>
                </div>
                <button id="downloadBtn" class="btn btn-primary">Resmi ƒ∞ndir üíæ</button>
                <button onclick="location.reload()" class="btn btn-secondary">Ba≈ütan Ba≈üla üîÑ</button>
            </div>
        </div>
    </div>

    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <h2>G√ºl√º≈ü√ºn Tasarlanƒ±yor...</h2>
        <p>Bu i≈ülem yakla≈üƒ±k 1 dakika s√ºrebilir.</p>
    </div>

    <script>
       <script>
        // Deƒüi≈ükenler
        let uploadedFile, uploadedBase64;
        let selectedTone, selectedShape;

        // Elementler
        const screens = document.querySelectorAll('.screen');
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const previewImage = document.getElementById('previewImage');
        const nextBtn1 = document.getElementById('nextBtn1');
        const generateBtn = document.getElementById('generateBtn');
        const consentCheckbox = document.getElementById('consentCheckbox');
        const loading = document.getElementById('loadingOverlay');

        // Ekran Deƒüi≈ütirme
        function switchScreen(n) {
            screens.forEach(s => s.classList.remove('active'));
            document.getElementById(`screen${n}`).classList.add('active');
        }

        // Dosya Y√ºkleme
        uploadArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(!file) return;
            uploadedFile = file;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                uploadedBase64 = e.target.result;
                previewImage.src = uploadedBase64;
                previewImage.classList.add('visible');
                uploadArea.classList.add('has-file');
                checkScreen1();
            };
            reader.readAsDataURL(file);
        });

        consentCheckbox.addEventListener('change', checkScreen1);
        function checkScreen1() {
            nextBtn1.disabled = !(uploadedFile && consentCheckbox.checked);
        }
        nextBtn1.onclick = () => switchScreen(2);

        // Se√ßimler
        document.querySelectorAll('.option-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const type = btn.dataset.type;
                document.querySelectorAll(`[data-type="${type}"]`).forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                
                if(type === 'tone') selectedTone = btn.dataset.value;
                if(type === 'shape') selectedShape = btn.dataset.value;
                generateBtn.disabled = !(selectedTone && selectedShape);
            });
        });

        // ==========================================
        // D√úZELTƒ∞LMƒ∞≈û GENERATE FONKSƒ∞YONU (HATA BURADAYDI)
        // ==========================================
        generateBtn.onclick = async () => {
            loading.classList.add('active');
            
            try {
                // 1. Maske Olu≈ütur
                const maskBase64 = await createSimpleMask(uploadedBase64);
                
                // 2. Backend'e ƒ∞stek At
                const prompt = `A professional dental smile transformation. ${selectedTone === 'natural' ? 'Natural ivory teeth' : 'Bright white Hollywood smile'}. ${selectedShape === 'natural' ? 'Organic tooth shape' : 'Perfect veneer alignment'}. Photorealistic.`;
                
                const res = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        imageBase64: uploadedBase64,
                        maskBase64: maskBase64,
                        prompt: prompt
                    })
                });
                
                // Cevabƒ± metin olarak alƒ±p kontrol edelim (JSON hatasƒ± olmasƒ±n)
                const responseText = await res.text();
                let data;
                
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    throw new Error("Sunucu JSON d√∂nd√ºrmedi: " + responseText.substring(0, 50) + "...");
                }

                // API'den hata d√∂nd√ºyse fƒ±rlat
                if(!res.ok || data.error) {
                    throw new Error(data.error || data.message || 'Sunucu hatasƒ±');
                }
                
                // HATA BURADAYDI: tasklist kontrol√º yapmadan okumaya √ßalƒ±≈üƒ±yorduk
                if (!data.tasklist || !data.tasklist[0]) {
                    console.log("Hatalƒ± API Cevabƒ±:", data);
                    // Hatanƒ±n detayƒ±nƒ± kullanƒ±cƒ±ya g√∂sterelim
                    throw new Error("API Beklenmeyen Cevap D√∂nd√ºrd√º: " + JSON.stringify(data));
                }
                
                // 3. Task ID Ba≈üarƒ±lƒ±ysa Devam Et
                const taskUuid = data.tasklist[0].uuid;
                console.log("Task ID:", taskUuid);
                
                const resultUrl = await checkStatus(taskUuid);
                
                // 4. Sonucu G√∂ster
                document.getElementById('beforeImage').src = uploadedBase64;
                document.getElementById('afterImage').src = resultUrl;
                
                document.getElementById('downloadBtn').onclick = () => {
                    const link = document.createElement('a');
                    link.href = resultUrl;
                    link.download = 'yeni-gulusum.png';
                    link.click();
                };

                loading.classList.remove('active');
                switchScreen(3);

            } catch (err) {
                loading.classList.remove('active');
                // Hatayƒ± alert kutusunda g√∂ster ki telefonda da g√∂rebilelim
                alert("HATA: " + err.message);
                console.error(err);
            }
        };

        // Yardƒ±mcƒ± Fonksiyon: Status Kontrol√º
        async function checkStatus(taskId) {
            for(let i=0; i<45; i++) { 
                await new Promise(r => setTimeout(r, 2000));
                
                const res = await fetch(`/api/status?taskId=${taskId}`);
                if(!res.ok) continue;
                
                const data = await res.json();
                
                // Eƒüer status cevabƒ± da hatalƒ±ysa
                if(!data.tasklist || !data.tasklist[0]) continue;

                const task = data.tasklist[0];
                
                if(task.status === 'task_postprocess_end') {
                    return task.parameters.outputImage;
                }
                
                if(task.status.includes('fail') || task.status.includes('error')) {
                    throw new Error('ƒ∞≈ülem ba≈üarƒ±sƒ±z: ' + (task.debugerror || task.status));
                }
            }
            throw new Error('Zaman a≈üƒ±mƒ±.');
        }

        function createSimpleMask(base64) {
            return new Promise(resolve => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = 'black';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    const w = img.width * 0.4;
                    const h = img.height * 0.15;
                    const x = (img.width - w) / 2;
                    const y = img.height * 0.62;
                    ctx.fillStyle = 'white';
                    ctx.fillRect(x, y, w, h);
                    resolve(canvas.toDataURL('image/png'));
                };
                img.src = base64;
            });
        }
    </script>
    </script>
</body>
</html>
